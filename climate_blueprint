blueprint:
  name: "Responsive Temperature-based Climate Control with Sensor Safety"
  description: "Control a climate device based on temperature sensor readings with customizable thresholds, dynamic settings, and safety features"
  domain: automation
  input:
    climate_entity:
      name: Climate Device
      selector:
        entity:
          domain: climate
    temperature_sensor:
      name: Temperature Sensor
      selector:
        entity:
          domain: sensor
          device_class: temperature
    base_temperature_input:
      name: Base Temperature Input Number
      description: "The input_number entity for base temperature"
      selector:
        entity:
          domain: input_number
    upper_threshold:
      name: Upper Threshold
      description: "Temperature difference above base to trigger cooling"
      selector:
        number:
          min: 0
          max: 10
          step: 0.1
          unit_of_measurement: "°C"
    lower_threshold:
      name: Lower Threshold
      description: "Temperature difference below base to turn off climate"
      selector:
        number:
          min: 0
          max: 10
          step: 0.1
          unit_of_measurement: "°C"
    enable_automation_input:
      name: Enable Automation Input Boolean
      description: "The input_boolean entity to enable or disable the automation"
      selector:
        entity:
          domain: input_boolean

variables:
  climate_entity: !input climate_entity
  temperature_sensor: !input temperature_sensor
  base_temperature_input: !input base_temperature_input
  upper_threshold: !input upper_threshold
  lower_threshold: !input lower_threshold
  enable_automation_input: !input enable_automation_input

trigger:
  - platform: state
    entity_id: 
      - !input temperature_sensor
      - !input base_temperature_input
      - !input enable_automation_input
  - platform: numeric_state
    entity_id: !input temperature_sensor
    above: "{{ states(base_temperature_input) | float }}"
  - platform: numeric_state
    entity_id: !input temperature_sensor
    below: "{{ states(base_temperature_input) | float }}"

action:
  - variables:
      current_temp: "{{ states(temperature_sensor) | float }}"
      base_temp: "{{ states(base_temperature_input) | float }}"
  - choose:
      # When temperature sensor is unavailable
      - conditions:
          - condition: state
            entity_id: !input temperature_sensor
            state: "unavailable"
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entity
            data:
              hvac_mode: "off"
          - service: notify.persistent_notification
            data:
              message: "Climate control turned off due to unavailable temperature sensor."
              title: "Climate Control Safety Alert"

      # When automation is enabled and sensor is available
      - conditions:
          - condition: state
            entity_id: !input enable_automation_input
            state: "on"
          - condition: not
            conditions:
              - condition: state
                entity_id: !input temperature_sensor
                state: "unavailable"
        sequence:
          - choose:
              # Temperature above threshold
              - conditions:
                  - condition: template
                    value_template: "{{ current_temp > (base_temp + upper_threshold) }}"
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: !input climate_entity
                    data:
                      hvac_mode: cool
                  - service: climate.set_temperature
                    target:
                      entity_id: !input climate_entity
                    data:
                      temperature: "{{ base_temp }}"
              # Temperature below threshold
              - conditions:
                  - condition: template
                    value_template: "{{ current_temp < (base_temp - lower_threshold) }}"
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: !input climate_entity
                    data:
                      hvac_mode: "off"

      # When automation is disabled
      - conditions:
          - condition: state
            entity_id: !input enable_automation_input
            state: "off"
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entity
            data:
              hvac_mode: "off"
